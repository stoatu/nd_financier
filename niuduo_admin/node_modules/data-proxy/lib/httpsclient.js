var qs = require('querystring');
var https = require('https');
var httpsconf = require('./httpsconf');

//默认配置
var options = {
    host: httpsconf.host,
    port: httpsconf.port,
    method: 'POST',
    headers: {
        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
        //'Transfer-Encoding':'chunked'
    }
};

exports.handle = function(req,res,opt){

    if(opt.url == null ||  opt.url == undefined ){
        res.status(500).send("fatal error : url is not defined in the data-request");
    }
    options.host = opt.host || httpsconf.host;
    var root = opt.root || "";
    var paramstr="";
    if(typeof(opt.params)=="string"){
        paramstr=opt.params;
    }else{
        paramstr=qs.stringify(opt.params);
    }
    options.method = opt.method || "POST";
    if(options.method=="GET"){
        options.path = root + opt.url+"?"+paramstr;
    }else{
        var length = paramstr.length;
        if (!Buffer.isBuffer(paramstr)) {
            length = Buffer.byteLength(paramstr);
        }
        options.headers['Content-Length']=length;
    }
    options.agent = new https.Agent(options);

    //callback defined
    var success = opt.success;
    var error = opt.error;
    var httpclientError = opt.httpclientError;

    //request defined
    var request = https.request(options, function(feedback) {

        if (feedback.statusCode == 200) {
            var body = "";
            feedback.setEncoding('utf8');
            feedback.on('data', function (chunk) {
                //console.log('BODY: ' + chunk);
                body += chunk;
            }).on('end',function(){
                //callback
                if(success){
                    success(res,body);
                }else{
                    res.status(200).send(body);
                }
            });
        }else {
            if(error){
                error(res);
            }else{
                res.status(500).send("error caught in the data response which status-code is 500!");
            }
        }

    }).on('error', function(e) {
        console.log('problem with request: ' + e.message);
        if(httpclientError){
            httpclientError(res);
        }else{
            res.status(500).send("error occurred with request: "+ e.message);
        }
    });

    // write data to request body
    if(opt.params){
        if(opt.method=="RAW"){
            request.write(JSON.stringify(opt.params));
        }else{
            request.write(paramstr);
        }
    }
    console.log(options.method+" https://"+options.host+":"+options.port+options.path+" data:"+paramstr);
    request.end();
}